<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Beniah Games</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root{
            --bg:#0d0e10; --panel:#14161b; --panel-2:#1a1d24; --text:#e9eef6; --muted:#a8b0bd;
            --accent:#ffcc00; --accent-2:#ffd84d; --link:#ffcc00; --border:#242834;
            --shadow:0 10px 30px rgba(0,0,0,.35);
        }
        *{box-sizing:border-box}
        html{scroll-behavior:smooth}
        body{
            margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Arial,sans-serif;
            background:var(--bg);color:var(--text);
            position:relative; z-index:0; /* for parallax layering */
        }

        /* --- PARALLAX BACKGROUND (scroll-driven + twinkle) --- */
        .parallax{
            position:fixed; 
            top:0; left:0; right:0; 
            height:100vh; /* Use initial viewport height */
            min-height:100vh; /* Ensure minimum height */
            overflow:hidden; 
            z-index:-1;
        }
        
        /* Prevent mobile browser bar resize issues */
        @supports (height: 100dvh) {
            .parallax {
                height: 100dvh; /* Use dynamic viewport height if supported */
                min-height: 100dvh;
            }
        }
        .layer{
            position:absolute; background-repeat:repeat;
            will-change:transform, opacity;
            /* Make layers larger to account for parallax movement */
            top:-20%; left:-10%; right:-10%; bottom:-20%;
        }
        .layer-back{
            background:url('../assets/parallax-back.png') no-repeat center center;
            background-size:cover;
            opacity:.3;
        }
        .layer-mid{
            background:url('../assets/parallax-mid.png') repeat;
            background-size:96px 96px;
            opacity:.5;
        }
        .layer-front{
            background:url('../assets/parallax-front.png') repeat;
            background-size:64px 64px;
            opacity:.8;
        }

        /* Welcome Message Element */
        .welcome-element {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%) translateX(calc(100% - 40px));
            z-index: 1000;
            display: flex;
            align-items: center;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .welcome-element.show {
            transform: translateY(-50%) translateX(0);
        }

        .welcome-trigger {
            width: 40px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border: 2px solid var(--accent);
            border-right: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border-radius: 8px 0 0 8px;
            flex-shrink: 0;
        }

        .welcome-trigger:hover {
            background: linear-gradient(135deg, var(--accent-2), var(--accent));
            box-shadow: 0 10px 30px rgba(255, 204, 0, 0.2);
        }

        .welcome-trigger.faded {
            opacity: 0.4;
            transition: opacity 1s ease;
        }

        .welcome-trigger:not(.faded) {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .welcome-message {
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 2px solid var(--accent);
            border-left: 2px solid var(--accent);
            border-radius: 0 8px 8px 0;
            padding: 1rem;
            width: 280px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
        }

        .welcome-content {
            width: 100%;
        }

        .welcome-content p {
            margin: 0 0 0.75rem 0;
            color: var(--text);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .welcome-content p:last-child {
            margin-bottom: 0;
        }

        /* Buttons */
        .btn{display:inline-block;padding:.6rem .9rem;border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--text);text-decoration:none;cursor:pointer;transition:.25s}
        .btn:hover{background:var(--panel-2);border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,204,0,.15)}
        .btn-secondary{display:inline-block;padding:.5rem .8rem;border:1px solid var(--border);border-radius:8px;background:var(--panel);color:var(--muted);font-size:.85rem;cursor:pointer;transition:.25s}
        .btn-secondary:hover{background:var(--panel-2);color:var(--text);border-color:var(--accent)}
        .btn-discord{
            display:inline-flex;align-items:center;gap:.5rem;background:var(--accent);color:#111;
            font-weight:700;padding:.6rem 1rem;border-radius:12px;text-decoration:none;
            transition:transform .15s ease, box-shadow .2s ease;
        }
        .btn-discord:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,204,0,.4)}
        .btn-discord svg{width:20px;height:20px;fill:currentColor}

        /* Sticky Nav */
        .nav{position:sticky;top:0;z-index:40;backdrop-filter:saturate(140%) blur(6px);
            background:linear-gradient(180deg,rgba(13,14,16,.85),rgba(13,14,16,.65));border-bottom:1px solid var(--accent)}
        .nav-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:.65rem 1rem}
        .brand{display:flex;gap:.6rem;align-items:center;font-weight:700}
        .brand .dot{width:.8rem;height:.8rem;border-radius:50%;background:var(--accent)}
        .brand a{color:var(--text);text-decoration:none}
        .nav-links{display:flex;gap:1rem;align-items:center}
        .nav-links a{color:var(--text);text-decoration:none;opacity:.9;position:relative}
        .nav-links a:hover{opacity:1}
        .nav-links a::after{content:"";position:absolute;left:0;right:0;bottom:-4px;height:2px;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform .25s}
        .nav-links a:hover::after{transform:scaleX(1)}

        /* User Menu */
        .user-menu{position:relative;display:inline-block}
        .user-link{
            color:var(--text);text-decoration:none;opacity:.9;position:relative;
        }
        .user-link:hover{opacity:1}
        .user-link::after{
            content:"";position:absolute;left:0;right:0;bottom:-4px;height:2px;
            background:var(--accent);transform:scaleX(0);transform-origin:left;
            transition:transform .25s;
        }
        .user-link:hover::after{transform:scaleX(1)}
        .user-dropdown{
            position:absolute;top:100%;right:0;margin-top:.5rem;
            background:var(--panel);border:1px solid var(--border);border-radius:10px;
            box-shadow:var(--shadow);min-width:120px;opacity:0;visibility:hidden;
            transform:translateY(-8px);transition:all .25s ease;z-index:1000;
        }
        .user-menu:hover .user-dropdown{
            opacity:1;visibility:visible;transform:translateY(0);
        }
        .user-dropdown a{
            display:block;padding:.75rem 1rem;color:var(--text);
            text-decoration:none;transition:background .2s;
            border-bottom:1px solid var(--border);
        }
        .user-dropdown a:last-child{border-bottom:none}
        .user-dropdown a:hover{background:rgba(255,204,0,.1)}

        /* Language Dropdown */
        .language-selector{position:relative;display:inline-block}
        .language-btn{
            display:flex;align-items:center;gap:.4rem;padding:.5rem .7rem;
            border:1px solid var(--border);border-radius:8px;background:transparent;
            color:var(--text);cursor:pointer;font-size:.85rem;transition:.2s;
        }
        .language-btn:hover{border-color:var(--accent);background:rgba(255,204,0,.05)}
        .language-dropdown{
            position:absolute;top:100%;right:0;margin-top:.25rem;
            background:var(--panel);border:1px solid var(--border);border-radius:10px;
            box-shadow:var(--shadow);min-width:140px;opacity:0;visibility:hidden;
            transform:translateY(-8px);transition:all .25s ease;z-index:1000;
        }
        .language-dropdown.show{
            opacity:1 !important;
            visibility:visible !important;
            transform:translateY(0) !important;
            display:block !important;
        }
        .language-option{
            display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;
            color:var(--text);text-decoration:none;font-size:.85rem;
            border-bottom:1px solid var(--border);transition:.2s;
        }
        .language-option:last-child{border-bottom:none}
        .language-option:hover{background:rgba(255,204,0,.08);color:var(--accent)}
        .language-option.active{background:rgba(255,204,0,.12);color:var(--accent)}
        .flag{font-size:1.1em}
        @media(max-width:820px){
            .language-selector{margin-left:auto}
            .language-dropdown{right:0;left:auto}
        }

        /* Volume Control */
        .volume-control{position:relative;display:flex;align-items:center}
        .volume-btn{
            display:flex;align-items:center;justify-content:center;
            width:40px;height:40px;border:1px solid var(--border);
            border-radius:8px;background:transparent;color:var(--text);
            cursor:pointer;transition:all .2s ease;
        }
        .volume-btn:hover{border-color:var(--accent);background:rgba(255,204,0,.05)}
        .volume-btn.muted{opacity:0.5}
        .volume-icon{width:20px;height:20px;fill:currentColor}
        .volume-slider-container{
            position:absolute;top:100%;right:0;margin-top:.5rem;
            background:var(--panel);border:1px solid var(--border);
            border-radius:10px;box-shadow:var(--shadow);padding:1rem;
            min-width:200px;opacity:0;visibility:hidden;
            transform:translateY(-8px);transition:all .25s ease;z-index:1000;
        }
        .volume-slider-container.show{
            opacity:1;visibility:visible;transform:translateY(0);
        }
        .volume-slider{
            width:100%;height:4px;border-radius:2px;
            background:var(--border);outline:none;cursor:pointer;
            -webkit-appearance:none;appearance:none;
        }
        .volume-slider::-webkit-slider-thumb{
            -webkit-appearance:none;appearance:none;
            width:16px;height:16px;border-radius:50%;
            background:var(--accent);cursor:pointer;
            box-shadow:0 2px 6px rgba(0,0,0,.2);
        }
        .volume-slider::-moz-range-thumb{
            width:16px;height:16px;border-radius:50%;
            background:var(--accent);cursor:pointer;
            border:none;box-shadow:0 2px 6px rgba(0,0,0,.2);
        }
        .volume-percentage{
            text-align:center;margin-top:.5rem;
            font-size:.85rem;color:var(--text-secondary);
        }

        /* Mobile Navigation */
        .mobile-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* User Controls + Hamburger + Mobile Panel (slide + shadow + stagger) */
        .user-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-icon-container {
          position: relative;
          display: inline-block;
        }

        .user-icon {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 42px;
          height: 42px;
          border: 1px solid var(--accent);
          border-radius: 10px;
          cursor: pointer;
          background: transparent;
          transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .user-icon:hover {
          background-color: rgba(255, 204, 0, 0.1);
          border-color: var(--accent-2);
        }
        
        .user-icon svg {
          width: 20px;
          height: 20px;
          fill: var(--accent);
          transition: fill 0.3s ease;
        }
        
        .user-icon:hover svg {
          fill: var(--accent-2);
        }

        .user-icon-dropdown {
          position: absolute;
          top: 100%;
          right: 0;
          background: rgba(0, 0, 0, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid var(--accent);
          border-radius: 10px;
          min-width: 120px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          z-index: 1000;
          margin-top: 8px;
          overflow: hidden;
        }

        .user-icon-dropdown a {
          display: block;
          padding: 12px 16px;
          color: var(--accent);
          text-decoration: none;
          transition: background-color 0.3s ease, color 0.3s ease;
          font-size: 14px;
          border-bottom: 1px solid rgba(255, 204, 0, 0.1);
        }

        .user-icon-dropdown a:last-child {
          border-bottom: none;
        }

        .user-icon-dropdown a:hover {
          background: rgba(255, 204, 0, 0.1);
          color: var(--accent-2);
        }
        
        .hamburger{display:none;flex-direction:column;gap:.45rem;align-items:center;justify-content:center;width:42px;height:42px;border:1px solid var(--accent);border-radius:10px;cursor:pointer;background:transparent}
        .hamburger span{width:20px;height:2px;background:var(--accent);transition:.25s}
        .hamburger[aria-expanded="true"] span:nth-child(1){transform:translateY(6px) rotate(45deg)}
        .hamburger[aria-expanded="true"] span:nth-child(2){opacity:0}
        .hamburger[aria-expanded="true"] span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}
        /* Always show hamburger and hide desktop nav links */
        .nav-links > a{display:none}
        .hamburger{display:flex}
        
        /* Keep other nav-links elements visible (Spotify, language, volume, Discord) */
        .nav-links .now-playing,
        .nav-links .language-selector,
        .nav-links .volume-control,
        .nav-links .btn-discord {
            display: flex;
        }
        
        @media(max-width:820px){
            .nav-links{display:flex}
            .nav-links > a{display:none}
            .hamburger{display:flex}
        }
        .menu-panel{
            position:absolute;top:100%;left:0;right:0;background:rgba(13,14,16,.97);border-bottom:1px solid var(--border);
            transform-origin:top;transform:scaleY(0);opacity:0;pointer-events:none;
            transition:transform .28s ease,opacity .22s ease,box-shadow .28s ease;box-shadow:0 0 0 rgba(0,0,0,0);
            z-index: 999; /* ensure it appears above the nav */
        }
        .menu-panel.open{transform:scaleY(1);opacity:1;pointer-events:auto;box-shadow:0 8px 20px rgba(0,0,0,.45)}
        .menu-panel-inner{max-width:1100px;margin:0 auto;padding:.75rem 1rem;display:grid;gap:.5rem}
        .menu-panel a{
            position:relative;color:var(--text);text-decoration:none;padding:.6rem .2rem;border-radius:8px;
            opacity:0;transform:translateY(-6px);transition:opacity .28s ease, transform .32s ease, background .2s ease;
        }
        .menu-panel a:hover{background:#171a21}
        .menu-panel a::after{content:"";position:absolute;left:0;right:0;bottom:4px;height:2px;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform .25s}
        .menu-panel a:hover::after{transform:scaleX(1)}
        .menu-panel.open .menu-panel-inner a:nth-child(1){opacity:1;transform:none;transition-delay:40ms}
        .menu-panel.open .menu-panel-inner a:nth-child(2){opacity:1;transform:none;transition-delay:90ms}
        .menu-panel.open .menu-panel-inner a:nth-child(3){opacity:1;transform:none;transition-delay:140ms}
        .menu-panel.open .menu-panel-inner a:nth-child(4){opacity:1;transform:none;transition-delay:190ms}
        .menu-panel.open .menu-panel-inner a:nth-child(5){opacity:1;transform:none;transition-delay:240ms}
        .menu-panel.open .menu-panel-inner a:nth-child(6){opacity:1;transform:none;transition-delay:290ms}
        .menu-panel.open .menu-panel-inner a:nth-child(7){opacity:1;transform:none;transition-delay:340ms}
        @media (prefers-reduced-motion:reduce){.menu-panel,.menu-panel a{transition:none !important;transform:none !important}}

        /* Spotify Now Playing */
        .now-playing{display:flex;align-items:center;gap:.75rem;padding:.5rem;background:rgba(30,215,96,.1);border:1px solid rgba(30,215,96,.3);border-radius:8px;transition:all .3s ease}
        .now-playing:hover{background:rgba(30,215,96,.15);border-color:rgba(30,215,96,.5)}
        .np-art,.np-art-mobile{width:40px;height:40px;background:#333;border-radius:6px;flex-shrink:0;background-size:cover;background-position:center}
        .np-info,.np-info-mobile{flex:1;min-width:0;overflow:hidden}
        .np-title,.np-title-mobile{font-size:.85rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative}
        .np-artist,.np-artist-mobile{font-size:.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative}
        
        .np-link,.np-link-mobile{font-size:.7rem;color:#1db954;text-decoration:none;margin-top:.25rem;display:inline-block}
        .np-link:hover,.np-link-mobile:hover{text-decoration:underline}
        
        /* Scrolling text animation */
        @keyframes scroll-text {
            0% { transform: translateX(0); }
            20% { transform: translateX(0); }
            80% { transform: translateX(calc(var(--scroll-distance, -50px))); }
            100% { transform: translateX(calc(var(--scroll-distance, -50px))); }
        }
        
        .np-title.scrollable, .np-title-mobile.scrollable,
        .np-artist.scrollable, .np-artist-mobile.scrollable {
            position: relative;
        }
        
        .np-title.scrollable:hover, .np-title-mobile.scrollable:hover,
        .np-artist.scrollable:hover, .np-artist-mobile.scrollable:hover {
            color: transparent;
        }
        
        /* Create a wrapper for the full text that can scroll */
        .np-title.scrollable:hover::before, .np-title-mobile.scrollable:hover::before {
            content: attr(data-full-text);
            position: absolute;
            top: 0;
            left: 0;
            white-space: nowrap;
            animation: scroll-text 4s ease-in-out infinite;
            color: var(--text);
        }
        
        .np-artist.scrollable:hover::before, .np-artist-mobile.scrollable:hover::before {
            content: attr(data-full-text);
            position: absolute;
            top: 0;
            left: 0;
            white-space: nowrap;
            animation: scroll-text 4s ease-in-out infinite;
            color: var(--muted);
        }
        
        /* Desktop Now Playing */
        .now-playing.desktop-only{margin-left:1rem;max-width:200px}
        
        /* Mobile Now Playing */
        .now-playing.mobile-only{margin:1rem;background:rgba(30,215,96,.08);border:1px solid rgba(30,215,96,.2)}
        
        /* Responsive visibility */
        .desktop-only{display:flex}
        .mobile-only{display:none}
        @media (max-width:768px){
            .desktop-only{display:none}
            .mobile-only{display:flex}
        }

        /* Footer + Back to Top */
        footer{border-top:1px solid var(--accent);color:#98a1b3;text-align:center;padding:2rem 1rem;backdrop-filter:saturate(140%) blur(6px);background:linear-gradient(0deg,rgba(13,14,16,.85),rgba(13,14,16,.65))}
        #back-to-top{position:fixed;bottom:20px;right:20px;width:44px;height:44px;border-radius:50%;border:1px solid var(--border);background:rgba(20,22,27,.9);color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;opacity:0;pointer-events:none;transition:opacity .3s,transform .3s;z-index:50}
        #back-to-top.show{opacity:1;pointer-events:auto;transform:translateY(0)}
        #back-to-top:hover{background:#191d25}
        #back-to-top::after{content:"Back to top";position:absolute;right:110%;top:50%;transform:translateY(-50%) scale(.9);background:#191d25;color:var(--text);font-size:.75rem;padding:.25rem .5rem;border-radius:6px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;white-space:nowrap;border:1px solid var(--border)}
        #back-to-top:hover::after,#back-to-top:focus::after{opacity:1;transform:translateY(-50%) scale(1)}

        /* Main content */
        main{max-width:1100px;margin:0 auto;padding:2rem 1rem}
        section{margin:3rem 0}
        h2{margin:0 0 .75rem;font-size:1.6rem}
        .lead{color:var(--muted);max-width:65ch}

        /* Profile specific styles */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 3rem;
            align-items: start;
        }

        .info-section {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .info-section h2 {
            color: var(--accent);
            margin: 0 0 1.5rem 0;
            font-size: 1.5rem;
        }

        .info-item {
            margin-bottom: 1rem;
        }

        .info-label {
            color: var(--muted);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: var(--text);
            font-weight: 500;
        }

        .profile-section {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--panel-2);
            border: 3px solid var(--accent);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--accent);
        }

        .profile-header h1 {
            color: var(--text);
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .profile-status {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .profile-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: grid;
            gap: 0.5rem;
        }

        .form-label {
            color: var(--text);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.2s;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Username form styling */
        #username-form {
            margin-top: 1rem;
        }

        #username-form .form-group {
            margin-bottom: 1rem;
        }

        #username-form label {
            display: block;
            color: var(--text);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        #username-form input[type="text"] {
            width: 100%;
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-family: inherit;
            transition: border-color 0.2s;
        }

        #username-form input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        #username-form button[type="submit"] {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #username-form button[type="submit"]:hover {
            background: var(--accent-hover);
        }

        #status {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }

        #status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--panel-2);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .achievements {
            margin-top: 2rem;
        }

        .achievement-list {
            display: grid;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--panel-2);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .achievement-icon {
            font-size: 1.5rem;
        }

        .achievement-info h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text);
            font-size: 0.9rem;
        }

        .achievement-info p {
            margin: 0;
            color: var(--muted);
            font-size: 0.8rem;
        }

        .recent-activity {
            margin-top: 2rem;
        }

        .activity-list {
            display: grid;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .activity-item {
            padding: 0.75rem;
            background: var(--panel-2);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .activity-text {
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .success-message {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .welcome-element {
                transform: translateY(-50%) translateX(calc(100% - 35px));
            }
            
            .welcome-trigger {
                width: 35px;
                height: 70px;
                font-size: 1rem;
            }
            
            .welcome-message {
                width: 240px;
                padding: 0.8rem;
            }
            
            .welcome-content p {
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .main {
                padding: 2rem 1rem;
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .info-section {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .info-section:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Message Element -->
    <div class="welcome-element" id="welcome-element">
        <button class="welcome-trigger" id="welcome-trigger" aria-label="Welcome message">
            <span>ðŸ‘‹</span>
        </button>
        <div class="welcome-message" id="welcome-message">
            <div class="welcome-content">
                <p>Hey there, and welcome to my little corner of the web! Feel free to look around and enjoy your stay.</p>
                <p>Just a heads-up: the site's still a work in progress, so some info may change and a few things might not work as expected. If you do spot any bugs, I'd love to hear about them!</p>
            </div>
        </div>
    </div>

    <!-- Parallax layers -->
    <div class="parallax">
        <div class="layer layer-back"></div>
        <div class="layer layer-mid"></div>
        <div class="layer layer-front"></div>
    </div>

    <!-- Nav -->
    <nav class="nav" id="top">
        <div class="nav-inner">
            <div class="brand"><div class="dot"></div><a href="../#top"><img src="../assets/Beniah.Games.Logo.png" alt="Beniah.games" style="height: 48px; vertical-align: middle;"></a></div>

            <!-- Desktop -->
            <div class="nav-links">
                <a href="../#about" data-translate="nav.about">About</a>
                <a href="../#games" data-translate="nav.games">Games</a>
                <a href="../devlogs/" data-translate="nav.devlogs">Devlogs</a>
                <a href="../#contact" data-translate="nav.contact">Contact</a>

                

                <!-- Spotify Now Playing (Desktop) -->
                <div class="now-playing desktop-only" id="now-playing-desktop">
                    <div class="np-art" id="np-art"></div>
                    <div class="np-info">
                        <div class="np-title" id="np-title" data-translate="spotify.not_playing">Not playing</div>
                        <div class="np-artist" id="np-artist"></div>
                        <a class="np-link" id="np-link" href="#" target="_blank" rel="noopener" style="display:none;" data-translate="spotify.listen">â™ª Listen</a>
                    </div>
                </div>
                
                <a class="btn-discord" href="https://discord.gg/PW6UZWtZ7C" target="_blank" rel="noopener" aria-label="Discord">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.211.375-.445.865-.608 1.249a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.077.077 0 00.084-.027c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.104c-.652-.247-1.27-.55-1.845-.899a.077.077 0 01-.007-.127c.124-.093.248-.19.366-.287a.074.074 0 01.077-.01c3.869 1.776 8.065 1.776 11.896 0a.075.075 0 01.078.009c.118.098.242.195.366.288a.077.077 0 01-.006.127 12.298 12.298 0 01-1.846.898.077.077 0 00-.04.105c.36.698.772 1.364 1.225 1.994a.076.076 0 00.084.027 19.876 19.876 0 005.994-3.03.077.077 0 00.031-.056c.5-5.177-.838-9.673-3.548-13.66a.06.06 0 00-.031-.028zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.418 2.157-2.418 1.21 0 2.176 1.094 2.157 2.418 0 1.334-.956 2.419-2.157 2.419zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.418 2.157-2.418 1.21 0 2.176 1.094 2.157 2.418 0 1.334-.947 2.419-2.157 2.419z"/></svg>
                    Discord
                </a>
            </div>

            <!-- Mobile -->
            <div class="mobile-nav">
                <!-- Spotify Now Playing (Mobile) -->
                <div class="now-playing mobile-only" id="now-playing-mobile">
                    <div class="np-art" id="np-art-mobile"></div>
                    <div class="np-info">
                        <div class="np-title" id="np-title-mobile" data-translate="spotify.not_playing">Not playing</div>
                        <div class="np-artist" id="np-artist-mobile"></div>
                        <a class="np-link" id="np-link-mobile" href="#" target="_blank" rel="noopener" style="display:none;" data-translate="spotify.listen">â™ª Listen</a>
                    </div>
                </div>

                <!-- Language Selector -->
                <div class="language-selector" id="language-selector">
                    <button class="language-btn" id="language-btn" aria-label="Select language">
                        <span class="flag" id="current-flag">ðŸ‡ºðŸ‡¸</span>
                        <span id="current-lang">EN</span>
                        <span style="font-size:.7em">â–¼</span>
                    </button>
                    <div class="language-dropdown" id="language-dropdown">
                        <a href="#" class="language-option active" data-lang="en">
                            <span class="flag">ðŸ‡ºðŸ‡¸</span>
                            <span>English</span>
                        </a>
                        <a href="#" class="language-option" data-lang="nl">
                            <span class="flag">ðŸ‡³ðŸ‡±</span>
                            <span>Nederlands</span>
                        </a>
                        <a href="#" class="language-option" data-lang="de">
                            <span class="flag">ðŸ‡©ðŸ‡ª</span>
                            <span>Deutsch</span>
                        </a>
                        <a href="#" class="language-option" data-lang="fr">
                            <span class="flag">ðŸ‡«ðŸ‡·</span>
                            <span>FranÃ§ais</span>
                        </a>
                        <a href="#" class="language-option" data-lang="it">
                            <span class="flag">ðŸ‡®ðŸ‡¹</span>
                            <span>Italiano</span>
                        </a>
                        <a href="#" class="language-option" data-lang="es">
                            <span class="flag">ðŸ‡ªðŸ‡¸</span>
                            <span>EspaÃ±ol</span>
                        </a>
                    </div>
                </div>

                <!-- Volume Control -->
                <div class="volume-control" id="volume-control">
                    <button class="volume-btn" id="volume-btn" aria-label="Volume control">
                        <svg class="volume-icon" id="volume-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </button>
                    <div class="volume-slider-container" id="volume-slider-container">
                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="0" aria-label="Volume level">
                        <div class="volume-percentage" id="volume-percentage">0%</div>
                    </div>
                </div>

                <div class="user-icon-container">
                    <button class="user-icon" id="user-icon" aria-label="User menu">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </button>
                    <div class="user-icon-dropdown" id="user-icon-dropdown" style="display: none;">
                        <a href="/user/" data-translate="nav.profile">Profile</a>
                        <a href="#" id="user-icon-logout" data-translate="nav.logout">Logout</a>
                    </div>
                </div>
                <button class="hamburger" id="hamburger" aria-expanded="false" aria-label="Open menu">
                    <span></span><span></span><span></span>
                </button>
            </div>

            <!-- Mobile Panel -->
            <div class="menu-panel" id="menu-panel">
                <div class="menu-panel-inner">
                    <a href="../#about" data-translate="nav.about">About</a>
                    <a href="../#games" data-translate="nav.games">Games</a>
                    <a href="../devlogs/" data-translate="nav.devlogs">Devlogs</a>
                    <a href="../#contact" data-translate="nav.contact">Contact</a>
                    <a href="https://discord.gg/PW6UZWtZ7C" target="_blank" rel="noopener" data-translate="nav.discord">Join Discord</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">User Profile</h1>
            <p class="page-subtitle">Your gaming profile and statistics</p>
        </div>

        <!-- Profile Container -->
        <div class="profile-container">
            <div id="loading" class="loading">Loading profile...</div>
            <div id="error" class="error" style="display: none;"></div>
        
        <div id="profile-content" style="display: none;">
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar">U</div>
                <h1 id="profile-username">Username</h1>
                <p id="profile-email">user@example.com</p>
            </div>
            
            <div class="profile-info">
                <div class="info-section">
                    <h3>Account Information</h3>
                    <div class="info-item">
                        <span class="info-label">Username:</span>
                        <span class="info-value" id="info-username">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="info-email">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Member Since:</span>
                        <span class="info-value" id="info-created">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Login:</span>
                        <span class="info-value" id="info-last-login">-</span>
                    </div>
                </div>
                
                <div class="info-section">
                    <h3>Change Username</h3>
                    <form id="username-form">
                        <div class="form-group">
                            <label for="username">New username:</label>
                            <input type="text" id="username" name="username" autocomplete="username" placeholder="Enter new username" required />
                        </div>
                        <button type="submit">Update</button>
                        <p id="status"></p>
                    </form>
                </div>
                
                <div class="info-section">
                    <h3>Gaming Stats</h3>
                    <div class="info-item">
                        <span class="info-label">Games Played:</span>
                        <span class="info-value" id="info-games-played">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">High Score:</span>
                        <span class="info-value" id="info-high-score">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Playtime:</span>
                        <span class="info-value" id="info-playtime">0 minutes</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Achievements:</span>
                        <span class="info-value" id="info-achievements">0</span>
                    </div>
                </div>
            </div>
            
            <button class="edit-profile-btn" onclick="editProfile()">Edit Profile</button></div>
        </div>
    </main>



    <footer data-translate="footer.copyright">Â© 2025 Beniah Gepts.</footer>

    <!-- Back to top -->
    <button id="back-to-top" aria-label="Back to top" data-translate="ui.back_to_top">â†‘</button>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://nqhejsnfwfcilktnyqbi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xaGVqc25md2ZjaWxrdG55cWJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODQ3NzAsImV4cCI6MjA3Mzk2MDc3MH0.8ngjb28rPVPCj4SnLtLSeUFbeAoFsrcQlZXpq2D19Ag';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function loadProfile() {
            try {
                // Check if user is authenticated
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError || !user) {
                    showError('Please log in to view your profile.');
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 2000);
                    return;
                }
                
                // Always viewing current user's profile
                const isOwnProfile = true;

                // Try to fetch comprehensive profile data for current user
                let profile, currentRole, userProgress, targetUserId;
                
                try {
                    // Try to fetch profile data by user ID
                    const { data: profileData, error: pErr } = await supabase
                        .from('profiles')
                        .select('id, display_name, avatar_url, bio, username, email, created_at, games_played, high_score, total_playtime, achievements')
                        .eq('id', user.id)
                        .single();
                    
                    if (pErr && (pErr.code === 'PGRST116' || pErr.code === 'PGRST205')) {
                        // Profile table doesn't exist, use user auth data as fallback
                        console.log('Using user auth data as fallback...');
                        profile = {
                            id: user.id,
                            email: user.email,
                            username: user.user_metadata?.username || user.email.split('@')[0],
                            display_name: user.user_metadata?.username || user.email.split('@')[0],
                            created_at: user.created_at,
                            ...user.user_metadata
                        };
                        targetUserId = user.id;
                    } else if (pErr) {
                        console.log('Profile fetch error, using auth data:', pErr);
                        profile = {
                            id: user.id,
                            email: user.email,
                            username: user.user_metadata?.username || user.email.split('@')[0],
                            display_name: user.user_metadata?.username || user.email.split('@')[0],
                            created_at: user.created_at,
                            ...user.user_metadata
                        };
                        targetUserId = user.id;
                    } else {
                        profile = profileData;
                        targetUserId = profileData.id;
                        
                        // Fix for existing profiles: if username is null but display_name exists, update username
                        if (!profile.username && profile.display_name && isOwnProfile) {
                            console.log('Fixing missing username for existing profile...');
                            const { error: updateError } = await supabase
                                .from('profiles')
                                .update({ username: profile.display_name })
                                .eq('id', profile.id);
                            
                            if (!updateError) {
                                profile.username = profile.display_name;
                                console.log('Username updated to:', profile.username);
                            } else {
                                console.error('Failed to update username:', updateError);
                            }
                        }
                    }
                    
                    // Try to fetch role and progress data (optional)
                    try {
                        const [roleResult, progressResult] = await Promise.all([
                            supabase.from('user_current_role').select('role_id, role_tiers:role_id(code,name,color)').eq('user_id', targetUserId).single(),
                            supabase.from('user_progress').select('xp, level').eq('user_id', targetUserId).single()
                        ]);
                        
                        currentRole = roleResult.data;
                        userProgress = progressResult.data;
                    } catch (roleProgressError) {
                        console.log('Role/progress tables not available, using defaults');
                        currentRole = null;
                        userProgress = null;
                    }
                    
                } catch (error) {
                    console.error('Profile loading error:', error);
                    showError('Failed to load profile data. Please try again.');
                    return;
                }

                // Update page title
                document.title = `${profile.display_name || profile.username || user.email.split('@')[0]} - Beniah Games`;
                
                // Display profile data
                displayProfile(user, profile, currentRole, userProgress, isOwnProfile);
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showError('An error occurred while loading your profile.');
            }
        }

        function displayProfile(user, profile, currentRole, userProgress, isOwnProfile = false) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profile-content').style.display = 'block';

            // Set avatar initial - use display_name or username
            const displayName = profile.display_name || profile.username || user.email.split('@')[0];
            const avatarInitial = displayName.charAt(0).toUpperCase();
            document.getElementById('profile-avatar').textContent = avatarInitial;

            // Set header info
            document.getElementById('profile-username').textContent = displayName;
            document.getElementById('profile-email').textContent = user.email;

            // Set account info
            document.getElementById('info-username').textContent = profile.username || 'Not set';
            document.getElementById('info-email').textContent = user.email;
            document.getElementById('info-created').textContent = new Date(user.created_at || profile.created_at).toLocaleDateString();
            document.getElementById('info-last-login').textContent = user.last_sign_in_at ? 
                new Date(user.last_sign_in_at).toLocaleDateString() : 'Never';

            // Set gaming stats using progress data or fallback
            document.getElementById('info-games-played').textContent = profile.games_played || '0';
            document.getElementById('info-high-score').textContent = profile.high_score || '0';
            document.getElementById('info-playtime').textContent = (profile.total_playtime || 0) + ' minutes';
            document.getElementById('info-achievements').textContent = profile.achievements || '0';
            
            // Display role information if available
            if (currentRole && currentRole.role_tiers) {
                const roleElement = document.getElementById('info-role');
                if (roleElement) {
                    roleElement.textContent = currentRole.role_tiers.name || 'No role';
                    if (currentRole.role_tiers.color) {
                        roleElement.style.color = currentRole.role_tiers.color;
                    }
                }
            }
            
            // Display level and XP if available
            if (userProgress) {
                const levelElement = document.getElementById('info-level');
                const xpElement = document.getElementById('info-xp');
                if (levelElement) levelElement.textContent = userProgress.level || '1';
                if (xpElement) xpElement.textContent = userProgress.xp || '0';
            }
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function editProfile() {
            // For now, just show an alert. This could be expanded to show an edit form
            alert('Edit profile functionality coming soon!');
        }



        // User authentication state handling
        let isUserLoggedIn = false;
        
        async function checkAuthState() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (user) {
                    // User is logged in
                    isUserLoggedIn = true;
                } else {
                    // User is not logged in - redirect to main page
                    window.location.href = '../#signup';
                }
            } catch (error) {
                console.error('Error checking auth state:', error);
                window.location.href = '../#signup';
            }
        }

        // User icon click handler - shows dropdown
        const userIcon = document.getElementById('user-icon');
        userIcon.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Toggle dropdown
            const dropdown = document.getElementById('user-icon-dropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('user-icon-dropdown');
            const container = document.querySelector('.user-icon-container');
            
            if (!container.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Logout functionality for user icon dropdown
        document.getElementById('user-icon-logout').addEventListener('click', async (e) => {
            e.preventDefault();
            
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Redirect to main page after logout
                window.location.href = '../';
                
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            }
        });

        // Load profile when page loads
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthState();
            loadProfile();
            
            // Initialize username form after DOM is loaded
            initializeUsernameForm();
        });

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = '../';
            }
        });

        // Hamburger menu
        (() => {
            const hamburger = document.getElementById('hamburger');
            const panel = document.getElementById('menu-panel');
            
            if (hamburger && panel) {
                hamburger.addEventListener('click', async () => {
                    const isOpen = hamburger.getAttribute('aria-expanded') === 'true';
                    
                    // Play sound effect when opening menu
                    if (window.audioManager && !isOpen) {
                        await window.audioManager.playSound('holographicOpen');
                    }
                    
                    hamburger.setAttribute('aria-expanded', !isOpen);
                    panel.classList.toggle('open', !isOpen);
                });

                // Close menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!hamburger.contains(e.target) && !panel.contains(e.target)) {
                        hamburger.setAttribute('aria-expanded', 'false');
                        panel.classList.remove('open');
                    }
                });

                // Close menu when pressing escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        hamburger.setAttribute('aria-expanded', 'false');
                        panel.classList.remove('open');
                    }
                });
            }
         })();

         // Welcome Message
         (() => {
             const welcomeElement = document.getElementById('welcome-element');
             const welcomeTrigger = document.getElementById('welcome-trigger');
             const welcomeMessage = document.getElementById('welcome-message');
             let isMessageVisible = false;
             let fadeTimeout;

             if (welcomeElement && welcomeTrigger) {
                 function startFadeTimeout() {
                     clearFadeTimeout();
                     fadeTimeout = setTimeout(() => {
                         if (!isMessageVisible) {
                             welcomeTrigger.classList.add('faded');
                         }
                     }, 3000);
                 }

                 function clearFadeTimeout() {
                     if (fadeTimeout) {
                         clearTimeout(fadeTimeout);
                         fadeTimeout = null;
                     }
                     welcomeTrigger.classList.remove('faded');
                 }

                 function toggleWelcomeMessage() {
                     isMessageVisible = !isMessageVisible;
                     
                     if (isMessageVisible) {
                         welcomeElement.classList.add('show');
                         clearFadeTimeout();
                     } else {
                         welcomeElement.classList.remove('show');
                         startFadeTimeout();
                     }
                 }

                 function hideWelcomeMessage() {
                     if (isMessageVisible) {
                         isMessageVisible = false;
                         welcomeElement.classList.remove('show');
                         startFadeTimeout();
                     }
                 }

                 // Toggle message on trigger interaction (click and touch)
                 const handleWelcomeTrigger = async (e) => {
                     e.stopPropagation();
                     e.preventDefault(); // Prevent double-firing on mobile
                     toggleWelcomeMessage();
                     
                     // Play welcome click sound (auto-initializes audio if needed)
                     if (window.audioManager) {
                         await window.audioManager.playSound('welcomeClick');
                     }
                 };

                 welcomeTrigger.addEventListener('click', handleWelcomeTrigger);
                 welcomeTrigger.addEventListener('touchend', handleWelcomeTrigger);

                 // Hide message when clicking outside
                 document.addEventListener('click', (e) => {
                     if (!welcomeElement.contains(e.target)) {
                         hideWelcomeMessage();
                     }
                 });

                 // Hide message on escape key
                 document.addEventListener('keydown', (e) => {
                     if (e.key === 'Escape') {
                         hideWelcomeMessage();
                     }
                 });

                 // Handle keyboard navigation for accessibility
                 welcomeTrigger.addEventListener('keydown', (e) => {
                     if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault();
                         toggleWelcomeMessage();
                     }
                 });

                 // Reset fade on hover
                 welcomeTrigger.addEventListener('mouseenter', clearFadeTimeout);
                 welcomeTrigger.addEventListener('mouseleave', () => {
                     if (!isMessageVisible) {
                         startFadeTimeout();
                     }
                 });

                 // Start initial fade timeout
                 startFadeTimeout();
             }
          })();

          // Volume Control
          (() => {
              const volumeBtn = document.getElementById('volume-btn');
              const volumeIcon = document.getElementById('volume-icon');
              const volumeSliderContainer = document.getElementById('volume-slider-container');
              const volumeSlider = document.getElementById('volume-slider');
              const volumePercentage = document.getElementById('volume-percentage');
              
              if (volumeBtn && volumeIcon && volumeSliderContainer && volumeSlider && volumePercentage) {
                  let masterVolume = 50; // Default volume
                  
                  // Load saved volume from localStorage
                  try {
                      const savedVolume = localStorage.getItem('sound-level');
                      if (savedVolume !== null) {
                          masterVolume = parseInt(savedVolume);
                      }
                  } catch (error) {
                      console.warn('Failed to load volume from localStorage:', error);
                  }

                  function updateVolumeIcon() {
                      if (masterVolume === 0) {
                          volumeIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
                          volumeBtn.classList.add('muted');
                      } else if (masterVolume < 30) {
                          volumeIcon.innerHTML = '<path d="M7 9v6h4l5 5V4l-5 5H7z"/>';
                          volumeBtn.classList.remove('muted');
                      } else if (masterVolume < 70) {
                          volumeIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>';
                          volumeBtn.classList.remove('muted');
                      } else {
                          volumeIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
                          volumeBtn.classList.remove('muted');
                      }
                  }

                  function updateVolumeDisplay() {
                      volumeSlider.value = masterVolume;
                      volumePercentage.textContent = `${masterVolume}%`;
                      updateVolumeIcon();
                      
                      // Save volume level to localStorage
                      try {
                          localStorage.setItem('sound-level', masterVolume);
                      } catch (error) {
                          console.warn('Failed to save volume level to localStorage:', error);
                      }
                  }

                  // Volume slider change
                  volumeSlider.addEventListener('input', async (e) => {
                      masterVolume = parseInt(e.target.value);
                      updateVolumeDisplay();
                  });

                  // Volume button interaction - support both click and touch
                  const handleVolumeButtonInteraction = async (e) => {
                      e.stopPropagation();
                      e.preventDefault(); // Prevent double-firing on mobile
                      volumeSliderContainer.classList.toggle('show');
                  };

                  volumeBtn.addEventListener('click', handleVolumeButtonInteraction);
                  volumeBtn.addEventListener('touchend', handleVolumeButtonInteraction);

                  // Close volume slider when clicking/touching outside
                  const closeVolumeSlider = (e) => {
                      if (!document.getElementById('volume-control').contains(e.target)) {
                          volumeSliderContainer.classList.remove('show');
                      }
                  };

                  document.addEventListener('click', closeVolumeSlider);
                  document.addEventListener('touchend', closeVolumeSlider);

                  // Initialize volume display
                  updateVolumeDisplay();
              }
          })();

          // Language switching functionality
          (() => {
              const languageSelector = document.querySelector('#language-selector');
              const languageButton = document.querySelector('#language-btn');
              const languageOptions = document.querySelector('#language-dropdown');
              const languageItems = document.querySelectorAll('.language-option');
              
              // Check if all elements exist
              if (!languageSelector || !languageButton || !languageOptions) {
                  console.error('Language selector elements not found');
                  return;
              }
              
              // Get current language from localStorage or default to 'en'
              let currentLanguage = localStorage.getItem('selectedLanguage') || 'en';
              
              // Function to update all translatable elements
              const updateTranslations = (lang) => {
                  const elements = document.querySelectorAll('[data-translate]');
                  elements.forEach(element => {
                      const key = element.getAttribute('data-translate');
                      if (translations[lang] && translations[lang][key]) {
                          // Special handling for Spotify widget - only update if showing "Not playing" text
                          if (key === 'spotify.not_playing') {
                              // Check if the element currently shows a "Not playing" translation in any language
                              const isShowingNotPlaying = Object.values(translations).some(langTranslations => 
                                  langTranslations['spotify.not_playing'] === element.textContent
                              );
                              // Only update if it's currently showing "Not playing" text
                              if (isShowingNotPlaying) {
                                  element.innerHTML = translations[lang][key];
                              }
                          } else {
                              element.innerHTML = translations[lang][key];
                          }
                      }
                  });
              };
              
              // Function to update the language button display
              const updateLanguageButton = (lang) => {
                  const flagMap = {
                      'en': 'ðŸ‡ºðŸ‡¸',
                      'nl': 'ðŸ‡³ðŸ‡±', 
                      'de': 'ðŸ‡©ðŸ‡ª',
                      'it': 'ðŸ‡®ðŸ‡¹',
                      'es': 'ðŸ‡ªðŸ‡¸',
                      'fr': 'ðŸ‡«ðŸ‡·'
                  };
                  
                  const langMap = {
                      'en': 'EN',
                      'nl': 'NL',
                      'de': 'DE', 
                      'it': 'IT',
                      'es': 'ES',
                      'fr': 'FR'
                  };
                  
                  const currentFlag = document.getElementById('current-flag');
                  const currentLang = document.getElementById('current-lang');
                  
                  if (currentFlag && currentLang) {
                      currentFlag.textContent = flagMap[lang];
                      currentLang.textContent = langMap[lang];
                  }
                  
                  // Update active state in dropdown
                  languageItems.forEach(item => {
                      item.classList.toggle('active', item.dataset.lang === lang);
                  });
              };
              
              // Function to change language
              const changeLanguage = (lang) => {
                  if (translations[lang]) {
                      currentLanguage = lang;
                      localStorage.setItem('selectedLanguage', lang);
                      updateTranslations(lang);
                      updateLanguageButton(lang);
                      
                      // Close dropdown
                      languageOptions.classList.remove('show');
                      languageButton.setAttribute('aria-expanded', 'false');
                  }
              };
              
              // Initialize with current language
              updateTranslations(currentLanguage);
              updateLanguageButton(currentLanguage);
              
              // Toggle dropdown
              languageButton.addEventListener('click', (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  
                  const isOpen = languageOptions.classList.contains('show');
                  languageOptions.classList.toggle('show');
                  languageButton.setAttribute('aria-expanded', !isOpen);
              });
              
              // Handle language selection
              languageItems.forEach(item => {
                  item.addEventListener('click', (e) => {
                      e.preventDefault();
                      const selectedLang = item.dataset.lang;
                      changeLanguage(selectedLang);
                  });
              });
              
              // Close dropdown when clicking outside
              document.addEventListener('click', (e) => {
                  if (!languageSelector.contains(e.target)) {
                      languageOptions.classList.remove('show');
                      languageButton.setAttribute('aria-expanded', 'false');
                  }
              });
              
              // Close dropdown on escape key
              document.addEventListener('keydown', (e) => {
                  if (e.key === 'Escape' && languageOptions.classList.contains('show')) {
                      languageOptions.classList.remove('show');
                      languageButton.setAttribute('aria-expanded', 'false');
                  }
              });
              
              // Handle keyboard navigation in dropdown
              languageButton.addEventListener('keydown', (e) => {
                  if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault();
                      languageButton.click();
                  }
              });
              
              languageItems.forEach((item, index) => {
                  item.addEventListener('keydown', (e) => {
                      if (e.key === 'Enter' || e.key === ' ') {
                          e.preventDefault();
                          item.click();
                      } else if (e.key === 'ArrowDown') {
                          e.preventDefault();
                          const nextItem = languageItems[index + 1] || languageItems[0];
                          nextItem.focus();
                      } else if (e.key === 'ArrowUp') {
                          e.preventDefault();
                          const prevItem = languageItems[index - 1] || languageItems[languageItems.length - 1];
                          prevItem.focus();
                      }
                  });
              });
          })();

          // Add checkUsername function for username availability checking
          async function checkUsername(name) { 
              try {
                  console.log('Checking username availability for:', name);
                  
                  // Get current user to exclude their own username from the check
                  const { data: { user }, error: userError } = await supabase.auth.getUser();
                  if (userError || !user) {
                      console.error('Could not get current user for username check:', userError);
                      return true; // Allow the change if we can't verify
                  }
                  
                  // Check if username exists for other users (case-insensitive)
                  const { data, error } = await supabase
                      .from('profiles')
                      .select('id')
                      .ilike('username', name) // Case-insensitive match
                      .neq('id', user.id); // Exclude current user
                  
                  console.log('Username check result:', { data, error });
                  
                  if (error) { 
                      console.error('Username check error:', error); 
                      return true; // Allow the change if check fails
                  } 
                  
                  // Username is available if no other user has it
                  return data.length === 0; 
              } catch (err) {
                  console.error('Username check exception:', err);
                  console.warn('Skipping username availability check due to error');
                  return true; // Allow the username change to proceed
              }
          }

          // Username form initialization function
          function initializeUsernameForm() {
              console.log('Initializing username form...');
              
              const usernameForm = document.getElementById("username-form");
              const statusElement = document.getElementById("status");

              console.log('Username form elements:', { usernameForm, statusElement });
              console.log('Supabase client:', supabase);
              console.log('Supabase URL:', supabase?.supabaseUrl);

              if (usernameForm && statusElement) {
              usernameForm.addEventListener("submit", async (e) => {
                  e.preventDefault();
                  console.log('Username form submitted');
                  
                  const newUsername = document.getElementById("username").value.trim();
                  console.log('New username:', newUsername);

                  // Clear previous status
                  statusElement.textContent = "";
                  statusElement.className = "";

                  if (!newUsername) {
                      statusElement.textContent = "Please enter a username.";
                      statusElement.className = "error";
                      return;
                  }

                  // Show loading state
                  statusElement.textContent = "Updating username...";
                  statusElement.className = "loading";

                  try {
                      // Current logged in user
                      console.log('Getting current user...');
                      const { data: { user }, error: userErr } = await supabase.auth.getUser();
                      console.log('User data:', { user, userErr });
                      
                      if (userErr || !user) {
                          console.error('User authentication error:', userErr);
                          statusElement.textContent = "Not logged in. Please refresh and try again.";
                          statusElement.className = "error";
                          return;
                      }

                      // Check if username is available
                      console.log('Checking username availability...');
                      const isAvailable = await checkUsername(newUsername);
                      console.log('Username availability:', isAvailable);
                      
                      if (!isAvailable) {
                          statusElement.textContent = "Username is already taken. Please choose a different one.";
                          statusElement.className = "error";
                          return;
                      }

                      // Update their profile
                      console.log('Updating profile for user ID:', user.id);
                      const { data: updateData, error } = await supabase
                          .from("profiles")
                          .update({ username: newUsername, display_name: newUsername })
                          .eq("id", user.id)
                          .select();

                      console.log('Update result:', { updateData, error });
                      console.log('Update data length:', updateData ? updateData.length : 'null');

                      if (error) {
                          console.error('Profile update error:', error);
                          if (error.code === "23505") {
                              statusElement.textContent = "Username already taken.";
                              statusElement.className = "error";
                          } else if (error.code === "42501") {
                              statusElement.textContent = "Permission denied. Please check your account permissions.";
                              statusElement.className = "error";
                          } else {
                              statusElement.textContent = "Error: " + error.message;
                              statusElement.className = "error";
                          }
                      } else if (!updateData || updateData.length === 0) {
                          console.error('No rows were updated - possible RLS policy issue');
                          statusElement.textContent = "Update failed: No profile found or permission denied. Please check your account permissions.";
                          statusElement.className = "error";
                      } else {
                          console.log('Username updated successfully:', updateData);
                          statusElement.textContent = "Username updated successfully!";
                          statusElement.className = "success";
                          
                          // Update the displayed username in the profile
                          const usernameDisplay = document.getElementById("info-username");
                          const profileUsername = document.getElementById("profile-username");
                          if (usernameDisplay) usernameDisplay.textContent = newUsername;
                          if (profileUsername) profileUsername.textContent = newUsername;
                          
                          // Clear the form
                          document.getElementById("username").value = "";
                      }
                  } catch (error) {
                      console.error("Username update exception:", error);
                      statusElement.textContent = "An unexpected error occurred: " + error.message;
                      statusElement.className = "error";
                  }
              });
          } else {
              console.error('Username form or status element not found');
          }
      }
      </script>
</body>
</html>